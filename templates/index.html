<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ortho Route Planner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #242836;
            --border: #2e3348;
            --text: #e4e6f0;
            --text-muted: #8b8fa3;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        header h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        header h1 span { color: var(--accent); }

        .header-stats {
            margin-left: auto;
            font-size: 13px;
            color: var(--text-muted);
        }

        .menu-toggle {
            display: none;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .menu-toggle:hover {
            background: var(--border);
        }

        .menu-toggle svg {
            width: 20px;
            height: 20px;
        }

        /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar {
            width: 360px;
            min-width: 360px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .sidebar-section h2 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* â”€â”€ Form controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .field { margin-bottom: 12px; }

        .field label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus, input[type="number"]:focus, input[type="text"]:focus {
            border-color: var(--accent);
        }

        /* â”€â”€ Autocomplete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .autocomplete {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .autocomplete-input:focus {
            border-color: var(--accent);
        }

        .autocomplete-input::placeholder {
            color: var(--text-muted);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .autocomplete-dropdown.visible {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--surface);
        }

        .autocomplete-item.selected {
            background: var(--accent);
            color: white;
        }

        .autocomplete-item .city-name {
            font-size: 14px;
            font-weight: 500;
        }

        .autocomplete-item .city-stats {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .autocomplete-item.selected .city-stats {
            color: rgba(255,255,255,0.8);
        }

        .autocomplete-empty {
            padding: 16px 12px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .inline-fields {
            display: flex;
            gap: 8px;
        }

        .inline-fields .field { flex: 1; }

        .checkbox-field {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .checkbox-field input[type="checkbox"] {
            accent-color: var(--accent);
        }

        .checkbox-field label {
            font-size: 13px;
            color: var(--text);
            margin: 0;
        }

        /* â”€â”€ Transport toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .transport-toggle {
            display: flex;
            gap: 8px;
        }

        .transport-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transport-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .transport-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* â”€â”€ City info badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .city-info {
            display: none;
            padding: 8px 12px;
            background: var(--surface-2);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .city-info.visible { display: block; }

        .city-info .count {
            font-weight: 600;
            color: var(--accent);
        }

        /* â”€â”€ Route results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .route-stats {
            display: none;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .route-stats.visible { display: block; }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-card {
            background: var(--surface-2);
            border-radius: 6px;
            padding: 10px 12px;
        }

        .stat-card .val {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card .lbl {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* â”€â”€ Route list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .route-list {
            display: none;
            flex-shrink: 0;
        }

        .route-list.visible { display: block; }

        /* Tabs */
        .route-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            gap: 0;
        }

        .route-tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .route-tab:hover {
            color: var(--text);
        }

        .route-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .route-tab-badge {
            display: inline-block;
            background: var(--surface-2);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .route-tab.active .route-tab-badge {
            background: var(--accent);
            color: white;
        }

        .route-content {
            display: none;
        }

        .route-content.active {
            display: block;
        }

        .route-list-header {
            padding: 12px 20px 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
        }

        .route-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }

        .route-item:hover {
            background: var(--surface-2);
        }

        .route-item.visited {
            opacity: 0.6;
        }

        .route-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .route-num.start { background: var(--success); }
        .route-num.end { background: var(--danger); }
        .route-num.visited { background: var(--text-muted); }

        .route-detail {
            flex: 1;
            min-width: 0;
        }

        .route-detail .addr {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-detail .meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .route-detail .ortho-names {
            font-size: 11px;
            color: var(--accent);
            margin-top: 3px;
            font-weight: 500;
        }

        .ortho-name-link {
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
        }

        .ortho-name-link:hover {
            background: var(--surface-2);
            text-decoration: underline;
        }

        .route-duration {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
            flex-shrink: 0;
        }

        .route-duration strong {
            color: var(--text);
        }

        /* â”€â”€ Route actions (validation buttons) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .route-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .route-action-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .route-action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .route-action-btn.success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .route-action-btn.success:hover {
            background: #16a34a;
            border-color: #16a34a;
        }

        .route-action-btn.danger {
            background: var(--surface-2);
            border-color: var(--border);
            color: var(--danger);
        }

        .route-action-btn.danger:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .visited-info {
            font-size: 10px;
            color: var(--success);
            margin-top: 2px;
            font-weight: 500;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* â”€â”€ Letter Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .letter-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .letter-modal.visible {
            display: flex;
        }

        .letter-container {
            background: white;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .letter-header {
            background: var(--surface);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .letter-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .letter-actions {
            display: flex;
            gap: 8px;
        }

        .letter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .letter-btn.print {
            background: var(--accent);
            color: white;
        }

        .letter-btn.print:hover {
            background: var(--accent-hover);
        }

        .letter-btn.close {
            background: var(--surface-2);
            color: var(--text);
        }

        .letter-btn.close:hover {
            background: var(--border);
        }

        .letter-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: white;
        }

        /* Letter document styling (for print and display) */
        .letter-document {
            max-width: 595px; /* A4 width in pixels at 72 DPI */
            margin: 0 auto;
            background: white;
            color: #000;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.6;
        }

        .letter-from {
            margin-bottom: 40px;
            font-size: 10pt;
        }

        .letter-from strong {
            font-size: 11pt;
            display: block;
            margin-bottom: 4px;
        }

        .letter-date {
            text-align: right;
            margin-bottom: 40px;
            font-size: 10pt;
            font-style: italic;
        }

        .letter-to {
            margin-bottom: 30px;
        }

        .letter-to-name {
            font-weight: bold;
            font-size: 11pt;
        }

        .letter-to-address {
            font-size: 10pt;
            margin-top: 4px;
        }

        .letter-subject {
            margin-bottom: 20px;
            font-weight: bold;
            text-decoration: underline;
            font-size: 11pt;
        }

        .letter-body p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .letter-signature {
            margin-top: 40px;
            font-size: 11pt;
        }

        .letter-signature p {
            margin-bottom: 8px;
        }

        .letter-ps {
            margin-top: 30px;
            font-size: 10pt;
            font-style: italic;
            color: #444;
        }

        .letter-qr-section {
            margin: 20px 0 8px;
            padding: 16px;
            border: 1px solid #d9dde7;
            border-radius: 10px;
            background: #f8f9fc;
            text-align: center;
        }

        .letter-qr-label {
            font-size: 10.5pt;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .letter-qr-image {
            width: 128px;
            height: 128px;
            display: block;
            margin: 0 auto 8px;
        }

        .letter-qr-link {
            font-size: 10pt;
            color: #334155;
            text-decoration: none;
            font-weight: 600;
        }

        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }

            .letter-document, .letter-document * {
                visibility: visible;
            }

            .letter-document {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: none;
                padding: 0;
                margin: 0;
            }

            .letter-qr-section {
                background: #fff;
            }

            .letter-header,
            .letter-actions,
            .letter-btn {
                display: none !important;
            }
        }

        /* Mobile adjustments for letter modal */
        @media (max-width: 768px) {
            .letter-content {
                padding: 20px;
            }

            .letter-document {
                font-size: 11pt;
            }

            .letter-qr-image {
                width: 110px;
                height: 110px;
            }

            .letter-actions {
                flex-direction: column;
            }

            .letter-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* â”€â”€ Map area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .map-area {
            flex: 1;
            position: relative;
            background: var(--bg);
            min-height: 400px;
        }

        .map-area iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .map-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            color: var(--text-muted);
        }

        .map-placeholder svg {
            opacity: 0.3;
        }

        .map-placeholder p {
            font-size: 14px;
        }

        /* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(15, 17, 23, 0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.visible {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* â”€â”€ Error toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 400px;
            z-index: 200;
            display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }

        .toast.visible { display: block; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /*  RESPONSIVE MOBILE                                 */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        @media (max-width: 768px) {
            /* Header compact */
            header {
                padding: 10px 16px;
                flex-wrap: wrap;
            }

            header h1 {
                font-size: 16px;
            }

            .header-stats {
                font-size: 11px;
                width: 100%;
                margin-left: 0;
                margin-top: 4px;
            }

            /* Layout vertical sur mobile */
            .layout {
                flex-direction: column;
            }

            /* Menu toggle visible sur mobile */
            .menu-toggle {
                display: flex;
            }

            /* Sidebar devient une barre en haut (cachÃ©e par dÃ©faut) */
            .sidebar {
                width: 100%;
                min-width: 100%;
                max-height: 0;
                border-right: none;
                border-bottom: 1px solid var(--border);
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .sidebar.mobile-open {
                max-height: 60vh;
                overflow-y: auto;
            }

            .sidebar-section {
                padding: 12px 16px;
            }

            /* Stats plus compacts */
            .stat-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .stat-card {
                padding: 8px 10px;
            }

            .stat-card .val {
                font-size: 16px;
            }

            .stat-card .lbl {
                font-size: 10px;
            }

            /* Route list plus compact sur mobile */
            .route-list {
                max-height: 25vh;
                flex-shrink: 0;
            }

            .route-item {
                padding: 8px 16px;
            }

            .route-num {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .route-detail .addr {
                font-size: 12px;
            }

            .route-detail .ortho-names {
                font-size: 10px;
            }

            .route-duration {
                font-size: 11px;
            }

            /* Map prend le reste de l'espace disponible */
            .map-area {
                min-height: calc(100vh - 180px);
                flex: 1;
            }

            /* Quand la sidebar est ouverte, la carte reste visible */
            .sidebar.mobile-open ~ .map-area {
                min-height: calc(40vh - 60px);
            }

            /* Boutons plus gros pour le tactile */
            .btn {
                padding: 12px 16px;
                font-size: 15px;
            }

            /* Inline fields en colonne sur mobile */
            .inline-fields {
                flex-direction: column;
            }

            .inline-fields .field {
                width: 100%;
            }

            /* Autocomplete dropdown adaptÃ© */
            .autocomplete-dropdown {
                max-height: 200px;
            }

            /* Champs input/select adaptÃ©s mobile */
            select, input[type="text"], input[type="number"] {
                font-size: 14px;
                padding: 10px 12px;
            }

            .field label {
                font-size: 12px;
            }

            .field small {
                font-size: 10px !important;
            }

            /* Ajuster les placeholders sur mobile */
            #startAddress::placeholder {
                font-size: 13px;
            }

            /* Toast plus petit */
            .toast {
                bottom: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
                font-size: 13px;
            }
        }

        /* Tablettes portrait */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 320px;
                min-width: 320px;
            }

            .sidebar-section {
                padding: 14px 18px;
            }

            header h1 {
                font-size: 17px;
            }

            .header-stats {
                font-size: 12px;
            }

            .map-area {
                min-height: 500px;
            }
        }

        /* TrÃ¨s petits Ã©crans (< 375px) */
        @media (max-width: 374px) {
            header {
                padding: 8px 12px;
            }

            header h1 {
                font-size: 14px;
            }

            .sidebar-section {
                padding: 10px 12px;
            }

            .sidebar.mobile-open {
                max-height: 55vh;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                font-size: 14px;
                padding: 10px 14px;
            }

            /* Champs encore plus compacts sur petits Ã©crans */
            select, input[type="text"], input[type="number"] {
                font-size: 13px;
                padding: 8px 10px;
            }

            .field label {
                font-size: 11px;
            }

            .field small {
                font-size: 9px !important;
                line-height: 1.3;
            }

            #startAddress::placeholder {
                font-size: 12px;
            }

            .route-item {
                padding: 6px 12px;
                gap: 8px;
            }

            .route-num {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }

            .route-detail .addr {
                font-size: 11px;
            }

            .route-detail .ortho-names {
                font-size: 9px;
            }

            .route-list {
                max-height: 20vh;
            }

            .map-area {
                min-height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <button class="menu-toggle" id="menuToggle" aria-label="Menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
        </button>
        <h1><span>Ortho</span> Route Planner</h1>
        <div class="header-stats" id="headerStats">Chargementâ€¦</div>
    </header>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h2>Filtre</h2>

                <div class="field">
                    <label for="cityInput">Ville</label>
                    <div class="autocomplete">
                        <input
                            type="text"
                            id="cityInput"
                            class="autocomplete-input"
                            placeholder="Rechercher une ville..."
                            autocomplete="off"
                        >
                        <div id="cityDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>

                <div class="field">
                    <label for="deptSelect">Code postal / Arrondissement</label>
                    <select id="deptSelect">
                        <option value="">Toute la ville</option>
                    </select>
                </div>

                <div class="city-info" id="cityInfo">
                    <span class="count" id="cityInfoCount">0</span> sites â€”
                    <span id="cityInfoOrthos">0</span> orthophonistes
                </div>

                <!-- NOUVEAU : Point de dÃ©part personnalisÃ© -->
                <div class="field">
                    <label for="startAddress">ğŸ“ Point de dÃ©part (optionnel)</label>
                    <input
                        type="text"
                        id="startAddress"
                        placeholder="Ex: 15 Avenue des Champs-Ã‰lysÃ©es"
                        autocomplete="off"
                    >
                    <small style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;">
                        Entrez uniquement le numÃ©ro et le nom de la rue (la ville est dÃ©jÃ  sÃ©lectionnÃ©e)
                    </small>
                </div>

                <!-- Rayon de recherche (visible si point de dÃ©part renseignÃ©) -->
                <div class="field" id="radiusField" style="display:none;">
                    <label for="radiusSelect">Rayon de recherche</label>
                    <select id="radiusSelect">
                        <option value="">Toute la zone</option>
                        <option value="1">1 km</option>
                        <option value="1.5">1,5 km</option>
                        <option value="2">2 km</option>
                        <option value="3" selected>3 km</option>
                        <option value="5">5 km</option>
                    </select>
                </div>

                <!-- Mode de transport -->
                <div class="field">
                    <label>Mode de transport</label>
                    <div class="transport-toggle">
                        <button type="button" class="transport-btn active" data-mode="driving" id="btnDriving">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 17h14M5 17a2 2 0 01-2-2V9a2 2 0 012-2h1l2-3h8l2 3h1a2 2 0 012 2v6a2 2 0 01-2 2M5 17a2 2 0 00-2 2v1h4v-1a2 2 0 00-2-2zm14 0a2 2 0 00-2 2v1h4v-1a2 2 0 00-2-2z"/>
                            </svg>
                            Voiture
                        </button>
                        <button type="button" class="transport-btn" data-mode="foot" id="btnFoot">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="13" cy="4" r="2"/>
                                <path d="M7 21l3-4m0 0l2-2m-2 2l-2-4 4-3 2 1 3-2m-7 4l-1 5"/>
                            </svg>
                            A pied
                        </button>
                    </div>
                </div>

                <div class="inline-fields">
                    <div class="field">
                        <label for="tspLimit">TSP (sec)</label>
                        <input type="number" id="tspLimit" value="30" min="5" max="300">
                    </div>
                    <div class="field" style="display:flex;align-items:end;">
                        <div class="checkbox-field">
                            <input type="checkbox" id="closedLoop">
                            <label for="closedLoop">Boucle fermÃ©e</label>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="generateBtn" disabled>
                    GÃ©nÃ©rer l'itinÃ©raire
                </button>
            </div>

            <!-- Route stats -->
            <div class="route-stats" id="routeStats">
                <h2 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:10px;">RÃ©sultat</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="val" id="statSites">â€”</div>
                        <div class="lbl">Sites visitÃ©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="val" id="statDuration">â€”</div>
                        <div class="lbl">DurÃ©e totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="val" id="statAvg">â€”</div>
                        <div class="lbl">Moy. / segment</div>
                    </div>
                    <div class="stat-card">
                        <div class="val" id="statOrthos">â€”</div>
                        <div class="lbl">Orthos total</div>
                    </div>
                </div>
            </div>

            <!-- Route list with tabs -->
            <div class="route-list" id="routeList">
                <!-- Tabs -->
                <div class="route-tabs">
                    <div class="route-tab active" data-tab="tovisit">
                        Ã€ visiter
                        <span class="route-tab-badge" id="tovisitCount">0</span>
                    </div>
                    <div class="route-tab" data-tab="visited">
                        VisitÃ©s
                        <span class="route-tab-badge" id="visitedCount">0</span>
                    </div>
                </div>

                <!-- Content: Ã€ visiter -->
                <div class="route-content active" id="tovisitContent">
                    <div id="routeItems"></div>
                </div>

                <!-- Content: VisitÃ©s -->
                <div class="route-content" id="visitedContent">
                    <div id="visitedItems">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>Aucune visite validÃ©e pour le moment</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map -->
        <main class="map-area" id="mapArea">
            <div class="map-placeholder" id="mapPlaceholder">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <p>SÃ©lectionnez une ville et gÃ©nÃ©rez un itinÃ©raire</p>
            </div>

            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <p id="loadingText">Calcul de l'itinÃ©raire en coursâ€¦</p>
            </div>
        </main>
    </div>

    <!-- Error toast -->
    <div class="toast" id="toast"></div>

    <!-- Letter Modal -->
    <div class="letter-modal" id="letterModal">
        <div class="letter-container">
            <div class="letter-header">
                <h3>ğŸ“„ Lettre personnalisÃ©e</h3>
                <div class="letter-actions">
                    <button class="letter-btn print" onclick="printLetter()">
                        ğŸ–¨ï¸ Imprimer
                    </button>
                    <button class="letter-btn close" onclick="closeLetter()">
                        Fermer
                    </button>
                </div>
            </div>
            <div class="letter-content">
                <div class="letter-document" id="letterDocument">
                    <!-- Letter content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const cityInput = document.getElementById('cityInput');
        const cityDropdown = document.getElementById('cityDropdown');
        const deptSelect = document.getElementById('deptSelect');
        const cityInfo = document.getElementById('cityInfo');
        const generateBtn = document.getElementById('generateBtn');
        const mapArea = document.getElementById('mapArea');
        const mapPlaceholder = document.getElementById('mapPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const routeStats = document.getElementById('routeStats');
        const routeList = document.getElementById('routeList');
        const routeItems = document.getElementById('routeItems');
        const toast = document.getElementById('toast');
        const headerStats = document.getElementById('headerStats');

        let citiesData = [];
        let selectedCity = null;
        let selectedIndex = -1;
        let startPoint = null;  // {lat, lon, address}
        let currentRoute = [];  // Current route data
        let visitedSites = [];  // Visited sites with timestamp
        let transportMode = 'driving';  // 'driving' or 'foot'

        // â”€â”€ Visits API management (MongoDB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadVisitedSites() {
            try {
                const resp = await fetch('/api/visits');
                if (!resp.ok) throw new Error('Erreur chargement visites');
                const data = await resp.json();
                visitedSites = data.map(v => ({
                    site_id: v.site_id,
                    label: v.label || '',
                    lat: v.lat,
                    lon: v.lon,
                    visitedAt: v.visited_at,
                    visitedDate: v.visited_at ? new Date(v.visited_at).toLocaleDateString('fr-FR') : '',
                    visitedTime: v.visited_at ? new Date(v.visited_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '',
                }));
            } catch (e) {
                console.error('Failed to load visited sites', e);
                visitedSites = [];
            }
        }

        async function markAsVisited(siteData) {
            if (!siteData.site_id || isSiteVisited(siteData.site_id)) return false;

            try {
                const resp = await fetch('/api/visits', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        site_id: siteData.site_id,
                        label: siteData.label || '',
                        lat: siteData.lat,
                        lon: siteData.lon,
                    }),
                });
                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    throw new Error(errData.error || `Erreur serveur (${resp.status})`);
                }

                const doc = await resp.json();

                // Ajouter localement pour mise Ã  jour immÃ©diate de l'UI
                visitedSites.unshift({
                    site_id: doc.site_id,
                    label: doc.label || siteData.label || '',
                    orthos: siteData.orthos || 0,
                    orthos_list: siteData.orthos_list || [],
                    lat: doc.lat,
                    lon: doc.lon,
                    visitedAt: doc.visited_at,
                    visitedDate: new Date(doc.visited_at).toLocaleDateString('fr-FR'),
                    visitedTime: new Date(doc.visited_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                });
            } catch (e) {
                console.error('Failed to mark visited', e);
                showToast('Erreur : ' + e.message);
                return false;
            }

            updateVisitedList();
            updateTabCounts();
            return true;
        }

        async function unmarkAsVisited(siteId) {
            try {
                const resp = await fetch(`/api/visits/${encodeURIComponent(siteId)}`, {
                    method: 'DELETE',
                });
                if (!resp.ok) throw new Error('Erreur serveur');
            } catch (e) {
                console.error('Failed to unmark visited', e);
                showToast('Erreur : impossible de supprimer la visite');
                return;
            }

            visitedSites = visitedSites.filter(v => v.site_id !== siteId);
            updateVisitedList();
            updateTabCounts();
            refreshRouteDisplay();
        }

        function isSiteVisited(siteId) {
            if (!siteId) return false;
            return visitedSites.some(v => v.site_id === siteId);
        }

        // â”€â”€ Tab management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function initTabs() {
            document.querySelectorAll('.route-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;

                    // Update active tab
                    document.querySelectorAll('.route-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update active content
                    document.querySelectorAll('.route-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tabName}Content`).classList.add('active');
                });
            });
        }

        function updateTabCounts() {
            const toVisitCount = currentRoute.filter(r => !isSiteVisited(r.site_id)).length;
            const visitedCount = visitedSites.length;

            document.getElementById('tovisitCount').textContent = toVisitCount;
            document.getElementById('visitedCount').textContent = visitedCount;
        }

        function updateVisitedList() {
            const visitedItems = document.getElementById('visitedItems');

            if (visitedSites.length === 0) {
                visitedItems.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>Aucune visite validÃ©e pour le moment</p>
                    </div>
                `;
                return;
            }

            visitedItems.innerHTML = '';
            visitedSites.forEach((site, i) => {
                const div = document.createElement('div');
                div.className = 'route-item visited';

                // Build clickable names for visited sites
                let namesHtml = '';
                if (site.orthos_list && site.orthos_list.length > 0) {
                    const clickableNames = site.orthos_list.map((o, idx) => {
                        const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                        const orthoDataJson = JSON.stringify({
                            ...o,
                            address: site.label || site.address,
                            organization_address_line: site.address || site.label,
                            organization_postal_code: site.postal_code,
                            organization_city: site.city
                        }).replace(/"/g, '&quot;');
                        return `<span class="ortho-name-link" onclick='openLetter(${orthoDataJson})' title="Cliquer pour gÃ©nÃ©rer la lettre">${name}</span>`;
                    });
                    namesHtml = clickableNames.join(', ');
                } else {
                    namesHtml = `${site.orthos} orthophoniste${site.orthos > 1 ? 's' : ''}`;
                }

                div.innerHTML = `
                    <div class="route-num visited">âœ“</div>
                    <div class="route-detail">
                        <div class="addr">${site.label || site.address || 'â€”'}</div>
                        <div class="ortho-names" style="overflow: visible;">${namesHtml}</div>
                        <div class="visited-info">âœ“ VisitÃ© le ${site.visitedDate} Ã  ${site.visitedTime}</div>
                    </div>
                    <div class="route-actions">
                        <button class="route-action-btn danger" onclick="unmarkAsVisited('${site.site_id}')" title="Annuler la visite">
                            âœ•
                        </button>
                    </div>
                `;
                visitedItems.appendChild(div);
            });
        }

        // â”€â”€ Load cities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadCities() {
            try {
                const resp = await fetch('/api/cities');
                citiesData = await resp.json();

                const totalOrthos = citiesData.reduce((s, c) => s + c.orthos, 0);
                const totalSites = citiesData.reduce((s, c) => s + c.sites, 0);
                headerStats.textContent = `${citiesData.length} villes Â· ${totalSites} sites Â· ${totalOrthos} orthophonistes`;
            } catch (e) {
                showToast('Erreur de chargement des villes');
            }
        }

        // â”€â”€ Autocomplete filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function filterCities(query) {
            if (!query || query.length < 1) return [];

            query = query.toUpperCase();
            return citiesData.filter(c =>
                c.name.toUpperCase().includes(query)
            ).slice(0, 50); // Limit to 50 results
        }

        function renderDropdown(filtered) {
            if (filtered.length === 0) {
                cityDropdown.innerHTML = '<div class="autocomplete-empty">Aucune ville trouvÃ©e</div>';
                cityDropdown.classList.add('visible');
                return;
            }

            cityDropdown.innerHTML = filtered.map((c, i) => `
                <div class="autocomplete-item ${i === selectedIndex ? 'selected' : ''}" data-index="${i}">
                    <div class="city-name">${c.name}</div>
                    <div class="city-stats">${c.orthos} orthophonistes Â· ${c.sites} sites</div>
                </div>
            `).join('');

            cityDropdown.classList.add('visible');

            // Add click handlers
            cityDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.index);
                    selectCity(filtered[idx]);
                });
            });
        }

        function selectCity(city) {
            selectedCity = city;
            cityInput.value = city.name;
            cityDropdown.classList.remove('visible');
            selectedIndex = -1;
            updateCityInfo(city);
        }

        function updateCityInfo(city) {
            deptSelect.innerHTML = '<option value="">Toute la ville</option>';
            generateBtn.disabled = !city;

            if (city) {
                cityInfo.classList.add('visible');
                document.getElementById('cityInfoCount').textContent = city.sites;
                document.getElementById('cityInfoOrthos').textContent = city.orthos;

                if (city.depts.length > 1) {
                    city.depts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        deptSelect.appendChild(opt);
                    });
                }
            } else {
                cityInfo.classList.remove('visible');
            }
        }

        // â”€â”€ Input events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        cityInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            selectedIndex = -1;

            if (!query) {
                cityDropdown.classList.remove('visible');
                selectedCity = null;
                updateCityInfo(null);
                return;
            }

            const filtered = filterCities(query);
            renderDropdown(filtered);
        });

        cityInput.addEventListener('focus', (e) => {
            const query = e.target.value.trim();
            if (query) {
                const filtered = filterCities(query);
                renderDropdown(filtered);
            }
        });

        cityInput.addEventListener('keydown', (e) => {
            const items = cityDropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                renderDropdown(filterCities(cityInput.value.trim()));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                renderDropdown(filterCities(cityInput.value.trim()));
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    const filtered = filterCities(cityInput.value.trim());
                    selectCity(filtered[selectedIndex]);
                } else if (items.length === 1) {
                    const filtered = filterCities(cityInput.value.trim());
                    selectCity(filtered[0]);
                }
            } else if (e.key === 'Escape') {
                cityDropdown.classList.remove('visible');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete')) {
                cityDropdown.classList.remove('visible');
            }
        });

        // â”€â”€ Generate route â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        generateBtn.addEventListener('click', generateRoute);

        async function generateRoute() {
            if (!selectedCity) {
                showToast('Veuillez sÃ©lectionner une ville');
                return;
            }

            const city = selectedCity.name;
            const dept = deptSelect.value;
            const tspLimit = parseInt(document.getElementById('tspLimit').value) || 30;
            const closedLoop = document.getElementById('closedLoop').checked;

            // NOUVEAU : GÃ©rer le point de dÃ©part
            const startAddressInput = document.getElementById('startAddress').value.trim();

            if (!city) return;

            // Show loading
            generateBtn.disabled = true;
            loadingOverlay.classList.add('visible');
            routeStats.classList.remove('visible');
            routeList.classList.remove('visible');

            try {
                // NOUVEAU : GÃ©ocoder le point de dÃ©part si fourni
                if (startAddressInput) {
                    loadingText.textContent = 'GÃ©ocodage du point de dÃ©part...';

                    // Utiliser la ville et le dÃ©partement sÃ©lectionnÃ©s
                    const geocodeResp = await fetch('/api/geocode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            address: startAddressInput,
                            city: city,
                            postal_code: dept
                        }),
                    });

                    const geocodeData = await geocodeResp.json();

                    if (!geocodeResp.ok) {
                        showToast(geocodeData.error || 'Impossible de gÃ©ocoder l\'adresse de dÃ©part');
                        generateBtn.disabled = false;
                        loadingOverlay.classList.remove('visible');
                        return;
                    }

                    startPoint = {
                        lat: geocodeData.latitude,
                        lon: geocodeData.longitude,
                        address: geocodeData.geocoded_label
                    };

                    loadingText.textContent = `DÃ©part: ${startPoint.address}`;
                } else {
                    startPoint = null;
                }

                const modeLabel = transportMode === 'foot' ? 'a pied' : 'en voiture';
                loadingText.textContent = `Calcul de l'itinÃ©raire ${modeLabel}â€¦`;

                const body = {
                    city: city,
                    dept: dept,
                    closed_loop: closedLoop,
                    tsp_limit: tspLimit,
                    transport_mode: transportMode,
                };

                // Ajouter point de dÃ©part et rayon si dÃ©finis
                if (startPoint) {
                    body.start_lat = startPoint.lat;
                    body.start_lon = startPoint.lon;
                    body.start_address = startPoint.address;

                    const radiusVal = document.getElementById('radiusSelect').value;
                    if (radiusVal) {
                        body.radius_km = parseFloat(radiusVal);
                    }
                }

                const resp = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body),
                });

                const data = await resp.json();

                if (!resp.ok) {
                    showToast(data.error || 'Erreur serveur');
                    return;
                }

                // Show map
                mapPlaceholder.style.display = 'none';
                const existingIframe = mapArea.querySelector('iframe');
                if (existingIframe) existingIframe.remove();

                const iframe = document.createElement('iframe');
                iframe.srcdoc = data.map_html;
                mapArea.appendChild(iframe);

                // Show stats
                if (data.stats) {
                    const s = data.stats;
                    if (s.visited_sites) {
                        document.getElementById('statSites').textContent = s.visited_sites;
                        document.getElementById('statDuration').textContent =
                            s.total_duration_h >= 1
                                ? `${s.total_duration_h}h`
                                : `${s.total_duration_min} min`;
                        document.getElementById('statAvg').textContent = `${s.avg_segment_min} min`;

                        const totalOrthos = data.route.reduce((sum, r) => sum + r.orthos, 0);
                        document.getElementById('statOrthos').textContent = totalOrthos;

                        routeStats.classList.add('visible');
                    }

                    if (s.message) {
                        showToast(s.message);
                    }
                }

                // Show route list
                if (data.route && data.route.length > 0) {
                    currentRoute = data.route;
                    routeItems.innerHTML = '';
                    const n = data.route.length;

                    data.route.forEach((r, i) => {
                        const div = document.createElement('div');
                        const isVisited = isSiteVisited(r.site_id);
                        div.className = 'route-item' + (isVisited ? ' visited' : '');

                        let numClass = 'route-num';
                        if (isVisited) {
                            numClass += ' visited';
                        } else {
                            if (i === 0) numClass += ' start';
                            else if (i === n - 1) numClass += ' end';
                        }

                        // Build orthos names list with clickable names
                        let namesHtml = '';
                        let fullNames = '';
                        if (r.orthos_list && r.orthos_list.length > 0) {
                            // Create clickable name elements
                            const clickableNames = r.orthos_list.map((o, idx) => {
                                const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                                const orthoDataJson = JSON.stringify({
                                    ...o,
                                    address: r.label,
                                    organization_address_line: r.address || r.label,
                                    organization_postal_code: r.postal_code,
                                    organization_city: r.city
                                }).replace(/"/g, '&quot;');
                                return `<span class="ortho-name-link" onclick='openLetter(${orthoDataJson})' title="Cliquer pour gÃ©nÃ©rer la lettre">${name}</span>`;
                            });

                            fullNames = r.orthos_list.map(o => `${o.given_names || ''} ${o.family_name || ''}`.trim()).join(', ');

                            // Display first 2 names, then count
                            if (clickableNames.length === 1) {
                                namesHtml = `ğŸ‘¤ ${clickableNames[0]}`;
                            } else if (clickableNames.length === 2) {
                                namesHtml = `ğŸ‘¥ ${clickableNames[0]}, ${clickableNames[1]}`;
                            } else {
                                namesHtml = `ğŸ‘¥ ${clickableNames[0]}, ${clickableNames[1]} <span title="${fullNames}">(+${clickableNames.length - 2})</span>`;
                            }
                        } else {
                            namesHtml = `${r.orthos} orthophoniste${r.orthos > 1 ? 's' : ''}`;
                        }

                        const visitedBadge = isVisited ? '<div class="visited-info">âœ“ DÃ©jÃ  visitÃ©</div>' : '';

                        div.innerHTML = `
                            <div class="${numClass}">${isVisited ? 'âœ“' : r.order}</div>
                            <div class="route-detail">
                                <div class="addr" title="${r.label}">${r.label || 'â€”'}</div>
                                <div class="ortho-names" style="overflow: visible;">${namesHtml}</div>
                                ${visitedBadge}
                            </div>
                            <div class="route-duration">
                                ${r.segment_min > 0 ? `+<strong>${r.segment_min}</strong> min` : '<strong>DÃ©part</strong>'}
                            </div>
                            <div class="route-actions">
                                ${!isVisited ? `<button class="route-action-btn success" onclick="validateVisit(${i})" title="Marquer comme visitÃ©">âœ“</button>` : ''}
                            </div>
                        `;
                        routeItems.appendChild(div);
                    });

                    routeList.classList.add('visible');
                    updateTabCounts();
                }

            } catch (e) {
                showToast('Erreur rÃ©seau : ' + e.message);
            } finally {
                loadingOverlay.classList.remove('visible');
                generateBtn.disabled = false;
            }
        }

        // â”€â”€ Validate visit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function validateVisit(routeIndex) {
            if (routeIndex >= 0 && routeIndex < currentRoute.length) {
                const site = currentRoute[routeIndex];
                const ok = await markAsVisited(site);
                if (!ok) return;
                showToast(`âœ“ Visite validÃ©e : ${site.label || site.address}`);

                // Refresh the route display to update the UI
                refreshRouteDisplay();
            }
        }

        function refreshRouteDisplay() {
            const routeItems = document.getElementById('routeItems');
            if (currentRoute.length === 0) return;

            routeItems.innerHTML = '';
            const n = currentRoute.length;

            currentRoute.forEach((r, i) => {
                const div = document.createElement('div');
                const isVisited = isSiteVisited(r.site_id);
                div.className = 'route-item' + (isVisited ? ' visited' : '');

                let numClass = 'route-num';
                if (isVisited) {
                    numClass += ' visited';
                } else {
                    if (i === 0) numClass += ' start';
                    else if (i === n - 1) numClass += ' end';
                }

                // Build orthos names list with clickable names
                let namesHtml = '';
                let fullNames = '';
                if (r.orthos_list && r.orthos_list.length > 0) {
                    // Create clickable name elements
                    const clickableNames = r.orthos_list.map((o, idx) => {
                        const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                        const orthoDataJson = JSON.stringify({
                            ...o,
                            address: r.label,
                            organization_address_line: r.address || r.label,
                            organization_postal_code: r.postal_code,
                            organization_city: r.city
                        }).replace(/"/g, '&quot;');
                        return `<span class="ortho-name-link" onclick='openLetter(${orthoDataJson})' title="Cliquer pour gÃ©nÃ©rer la lettre">${name}</span>`;
                    });

                    fullNames = r.orthos_list.map(o => `${o.given_names || ''} ${o.family_name || ''}`.trim()).join(', ');

                    // Display first 2 names, then count
                    if (clickableNames.length === 1) {
                        namesHtml = `ğŸ‘¤ ${clickableNames[0]}`;
                    } else if (clickableNames.length === 2) {
                        namesHtml = `ğŸ‘¥ ${clickableNames[0]}, ${clickableNames[1]}`;
                    } else {
                        namesHtml = `ğŸ‘¥ ${clickableNames[0]}, ${clickableNames[1]} <span title="${fullNames}">(+${clickableNames.length - 2})</span>`;
                    }
                } else {
                    namesHtml = `${r.orthos} orthophoniste${r.orthos > 1 ? 's' : ''}`;
                }

                const visitedBadge = isVisited ? '<div class="visited-info">âœ“ DÃ©jÃ  visitÃ©</div>' : '';

                div.innerHTML = `
                    <div class="${numClass}">${isVisited ? 'âœ“' : r.order}</div>
                    <div class="route-detail">
                        <div class="addr" title="${r.label}">${r.label || 'â€”'}</div>
                        <div class="ortho-names" style="overflow: visible;">${namesHtml}</div>
                        ${visitedBadge}
                    </div>
                    <div class="route-duration">
                        ${r.segment_min > 0 ? `+<strong>${r.segment_min}</strong> min` : '<strong>DÃ©part</strong>'}
                    </div>
                    <div class="route-actions">
                        ${!isVisited ? `<button class="route-action-btn success" onclick="validateVisit(${i})" title="Marquer comme visitÃ©">âœ“</button>` : ''}
                    </div>
                `;
                routeItems.appendChild(div);
            });

            updateTabCounts();
        }

        // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 5000);
        }

        // â”€â”€ Transport mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.querySelectorAll('.transport-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                transportMode = btn.dataset.mode;
            });
        });

        // â”€â”€ Mobile menu toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.querySelector('.sidebar');

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-open');
            });

            // Close menu when generating route on mobile
            generateBtn.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('mobile-open');
                }
            });
        }

        // â”€â”€ Responsive placeholders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updatePlaceholders() {
            const startAddressInput = document.getElementById('startAddress');
            const width = window.innerWidth;

            if (width <= 374) {
                // TrÃ¨s petit mobile
                startAddressInput.placeholder = "Ex: 15 Ave Champs-Ã‰lysÃ©es";
                cityInput.placeholder = "Ville...";
            } else if (width <= 768) {
                // Mobile
                startAddressInput.placeholder = "Ex: 15 Avenue des Champs-Ã‰lysÃ©es";
                cityInput.placeholder = "Rechercher une ville...";
            } else {
                // Desktop
                startAddressInput.placeholder = "Ex: 15 Avenue des Champs-Ã‰lysÃ©es";
                cityInput.placeholder = "Rechercher une ville...";
            }
        }

        // Update on load and resize
        updatePlaceholders();
        window.addEventListener('resize', updatePlaceholders);

        // â”€â”€ Show/hide radius field based on start address â”€â”€â”€
        const startAddressField = document.getElementById('startAddress');
        const radiusField = document.getElementById('radiusField');

        startAddressField.addEventListener('input', () => {
            radiusField.style.display = startAddressField.value.trim() ? 'block' : 'none';
        });

        // â”€â”€ Letter Modal Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function generateLetterContent(orthoData) {
            const today = new Date().toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Format the recipient name
            const recipientName = orthoData.given_names && orthoData.family_name
                ? `${orthoData.given_names} ${orthoData.family_name}`
                : orthoData.organization_name || '';

            // CivilitÃ© : utiliser celle du backend (gender-guesser), sinon fallback
            const civility = orthoData.civility || 'Madame, Monsieur';

            // Salutation avec nom : "Madame Dupont" ou "Monsieur Martin" ou "Madame, Monsieur"
            const salutation = orthoData.family_name && civility !== 'Madame, Monsieur'
                ? `${civility} ${orthoData.family_name}`
                : `${civility}`;

            // "curieux" ou "curieuse" selon la civilitÃ©
            const curieux = civility === 'Madame' ? 'curieuse' : civility === 'Monsieur' ? 'curieux' : 'curieux(se)';

            // Format the address
            const addressLine = orthoData.organization_address_line || orthoData.address || '';
            const postalCode = orthoData.organization_postal_code || orthoData.postal_code || '';
            const city = orthoData.organization_city || orthoData.city || '';

            return `
                <div class="letter-to">
                    <div class="letter-to-name">${recipientName}</div>
                    <div class="letter-to-address">
                        ${addressLine}<br>
                        ${postalCode} ${city}
                    </div>
                </div>

                <div class="letter-date">
                    Paris, le ${today}
                </div>

                <div class="letter-subject">
                    Objet : Recherche de collaboration â€” plateforme pour orthophonistes
                </div>

                <div class="letter-body">
                    <p>${salutation},</p>

                    <p>
                        Je m'appelle Nathan Krief, j'ai 22 ans et je suis Ã©tudiant-entrepreneur.
                        Je dÃ©veloppe <strong>Logesia</strong>, une plateforme numÃ©rique conÃ§ue pour
                        libÃ©rer du temps clinique aux orthophonistes en rÃ©duisant la charge administrative.
                    </p>

                    <p><strong>Pourquoi je vous Ã©cris personnellement ?</strong></p>

                    <p>
                        Plus jeune, j'ai moi-mÃªme Ã©tÃ© suivi en orthophonie. Ma meilleure amie est
                        orthophoniste. En Ã©changeant avec elle, j'ai pris conscience du temps
                        considÃ©rable que le mÃ©tier consacre Ã  l'administratif â€” au dÃ©triment du
                        temps passÃ© avec les patients. J'ai voulu crÃ©er un outil pour rÃ©Ã©quilibrer cela.
                    </p>

                    <p><strong>ConcrÃ¨tement, Logesia vous permet de :</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li>rÃ©duire le temps passÃ© sur les comptes rendus et la documentation clinique ;</li>
                        <li>gÃ©nÃ©rer des exercices personnalisÃ©s, adaptÃ©s Ã  chaque patient et Ã  ses progrÃ¨s ;</li>
                        <li>structurer le suivi thÃ©rapeutique avec une trame adaptative, sÃ©ance aprÃ¨s sÃ©ance.</li>
                    </ul>

                    <p>
                        L'ensemble est assistÃ© par intelligence artificielle, mais vous gardez le
                        contrÃ´le Ã  chaque Ã©tape : c'est vous qui dÃ©cidez, l'outil s'adapte Ã  votre
                        pratique. Et ce n'est qu'un dÃ©but â€” de nombreuses fonctionnalitÃ©s sont en
                        cours de dÃ©veloppement.
                    </p>

                    <p><strong>Ce que je recherche, ce n'est pas un client, mais un regard d'expert.</strong></p>

                    <p>
                        La plateforme existe et fonctionne. Mais pour qu'elle soit vraiment utile au
                        quotidien, j'ai besoin de professionnels de terrain : vos retours, vos
                        suggestions et vos exigences sont essentiels.
                        ConcrÃ¨tement, je cherche des orthophonistes prÃªts Ã  tester Logesia et Ã  me
                        faire part de leurs observations, mÃªme les plus critiques.
                    </p>

                    <p>
                        En Ã©change, je vous offre un <strong>accÃ¨s gratuit pendant 1 an</strong> Ã 
                        l'ensemble de la plateforme.
                    </p>

                    <p>
                        Si vous Ãªtes ${curieux}, scannez le QR code ci-dessous pour dÃ©couvrir Logesia,
                        ou contactez-moi directement :
                    </p>

                    <div class="letter-qr-section">
                        <div class="letter-qr-label">Scannez ce QR code pour dÃ©couvrir Logesia :</div>
                        <img class="letter-qr-image" src="/qr-code.svg" alt="QR code vers Logesia">
                        <a class="letter-qr-link" href="https://logesia.com" target="_blank" rel="noopener noreferrer">logesia.com</a>
                    </div>
                </div>

                <div class="letter-signature">
                    <p><strong>Nathan Krief</strong></p>
                    <p>06 29 40 04 23</p>
                    <p>nathan@logesia.com</p>
                </div>

                <div class="letter-ps">
                    <p>
                        <strong>P.S. :</strong> Je serais Ã©galement ravi de vous rencontrer autour
                        d'un cafÃ© pour vous prÃ©senter la plateforme en personne : 30 minutes suffisent.
                    </p>
                </div>
            `;
        }

        function openLetter(orthoData) {
            const letterDocument = document.getElementById('letterDocument');
            const letterModal = document.getElementById('letterModal');

            letterDocument.innerHTML = generateLetterContent(orthoData);
            letterModal.classList.add('visible');

            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeLetter() {
            const letterModal = document.getElementById('letterModal');
            letterModal.classList.remove('visible');
            document.body.style.overflow = '';
        }

        function printLetter() {
            window.print();
        }

        // Close modal when clicking outside
        document.getElementById('letterModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'letterModal') {
                closeLetter();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLetter();
            }
        });

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function init() {
            await loadVisitedSites();
            initTabs();
            updateVisitedList();
            loadCities();
        }
        init();
    </script>
</body>
</html>
