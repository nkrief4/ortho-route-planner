<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ortho Route Planner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #242836;
            --border: #2e3348;
            --text: #e4e6f0;
            --text-muted: #8b8fa3;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        header h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        header h1 span { color: var(--accent); }

        .header-stats {
            margin-left: auto;
            font-size: 13px;
            color: var(--text-muted);
        }

        .menu-toggle {
            display: none;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .menu-toggle:hover {
            background: var(--border);
        }

        .menu-toggle svg {
            width: 20px;
            height: 20px;
        }

        /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .sidebar {
            width: 360px;
            min-width: 360px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .sidebar-section h2 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* ‚îÄ‚îÄ Form controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .field { margin-bottom: 12px; }

        .field label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus, input[type="number"]:focus, input[type="text"]:focus {
            border-color: var(--accent);
        }

        /* ‚îÄ‚îÄ Autocomplete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .autocomplete {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .autocomplete-input:focus {
            border-color: var(--accent);
        }

        .autocomplete-input::placeholder {
            color: var(--text-muted);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .autocomplete-dropdown.visible {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--surface);
        }

        .autocomplete-item.selected {
            background: var(--accent);
            color: white;
        }

        .autocomplete-item .city-name {
            font-size: 14px;
            font-weight: 500;
        }

        .autocomplete-item .city-stats {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .autocomplete-item.selected .city-stats {
            color: rgba(255,255,255,0.8);
        }

        .autocomplete-empty {
            padding: 16px 12px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .inline-fields {
            display: flex;
            gap: 8px;
        }

        .inline-fields .field { flex: 1; }

        .checkbox-field {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .checkbox-field input[type="checkbox"] {
            accent-color: var(--accent);
        }

        .checkbox-field label {
            font-size: 13px;
            color: var(--text);
            margin: 0;
        }

        /* ‚îÄ‚îÄ Transport toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .transport-toggle {
            display: flex;
            gap: 8px;
        }

        .transport-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transport-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .transport-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-gmaps {
            width: 100%;
            margin-top: 10px;
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-gmaps:hover {
            background: var(--border);
        }

        /* ‚îÄ‚îÄ City info badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .city-info {
            display: none;
            padding: 8px 12px;
            background: var(--surface-2);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .city-info.visible { display: block; }

        .city-info .count {
            font-weight: 600;
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ Route results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .route-stats {
            display: none;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .route-stats.visible { display: block; }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-card {
            background: var(--surface-2);
            border-radius: 6px;
            padding: 10px 12px;
        }

        .stat-card .val {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-card .lbl {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ‚îÄ‚îÄ Route list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .route-list {
            display: none;
            flex-shrink: 0;
        }

        .route-list.visible { display: block; }

        /* Tabs */
        .route-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            gap: 0;
        }

        .route-tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .route-tab:hover {
            color: var(--text);
        }

        .route-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .route-tab-badge {
            display: inline-block;
            background: var(--surface-2);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .route-tab.active .route-tab-badge {
            background: var(--accent);
            color: white;
        }

        .route-content {
            display: none;
        }

        .route-content.active {
            display: block;
        }

        .route-list-header {
            padding: 12px 20px 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
        }

        .route-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
        }

        .route-item:hover {
            background: var(--surface-2);
        }

        .route-item.visited {
            opacity: 0.6;
        }

        .route-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .route-num.start { background: var(--success); }
        .route-num.end { background: var(--danger); }
        .route-num.visited { background: var(--text-muted); }

        .route-detail {
            flex: 1;
            min-width: 0;
        }

        .route-detail .addr {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-detail .meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .route-detail .ortho-names {
            font-size: 11px;
            color: var(--accent);
            margin-top: 3px;
            font-weight: 500;
        }

        .ortho-name-link {
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
        }

        .ortho-name-link:hover {
            background: var(--surface-2);
            text-decoration: underline;
        }

        .route-duration {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
            flex-shrink: 0;
        }

        .route-duration strong {
            color: var(--text);
        }

        /* ‚îÄ‚îÄ Route actions (validation buttons) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .route-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .route-action-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .route-action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .route-action-btn.success {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .route-action-btn.success:hover {
            background: #16a34a;
            border-color: #16a34a;
        }

        .route-action-btn.danger {
            background: var(--surface-2);
            border-color: var(--border);
            color: var(--danger);
        }

        .route-action-btn.danger:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .visited-info {
            font-size: 10px;
            color: var(--success);
            margin-top: 2px;
            font-weight: 500;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* ‚îÄ‚îÄ Print all letters tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .printall-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .printall-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .printall-btn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .printall-btn:hover {
            background: var(--accent-hover);
        }

        .printall-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            gap: 10px;
            font-size: 13px;
        }

        .printall-item .printall-order {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--surface-2);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .printall-item .printall-info {
            flex: 1;
            min-width: 0;
        }

        .printall-item .printall-name {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .printall-item .printall-addr {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* (print-all letters opens in a dedicated window) */

        /* ‚îÄ‚îÄ Letter Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .letter-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .letter-modal.visible {
            display: flex;
        }

        .letter-container {
            background: white;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .letter-header {
            background: var(--surface);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .letter-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .letter-actions {
            display: flex;
            gap: 8px;
        }

        .letter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .letter-btn.print {
            background: var(--accent);
            color: white;
        }

        .letter-btn.print:hover {
            background: var(--accent-hover);
        }

        .letter-btn.close {
            background: var(--surface-2);
            color: var(--text);
        }

        .letter-btn.close:hover {
            background: var(--border);
        }

        .letter-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: white;
        }

        /* Letter document styling (for print and display) */
        .letter-document {
            max-width: 595px; /* A4 width in pixels at 72 DPI */
            margin: 0 auto;
            background: white;
            color: #000;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.6;
        }

        .letter-from {
            margin-bottom: 40px;
            font-size: 10pt;
        }

        .letter-from strong {
            font-size: 11pt;
            display: block;
            margin-bottom: 4px;
        }

        .letter-date {
            text-align: right;
            margin-bottom: 40px;
            font-size: 10pt;
            font-style: italic;
        }

        .letter-to {
            margin-bottom: 30px;
            text-align: left;
        }

        .letter-to-name {
            font-weight: bold;
            font-size: 11pt;
        }

        .letter-to-address {
            font-size: 10pt;
            margin-top: 4px;
        }

        .letter-subject {
            margin-bottom: 20px;
            font-weight: bold;
            text-decoration: underline;
            font-size: 11pt;
        }

        .letter-body p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .letter-signature {
            margin-top: 40px;
            font-size: 11pt;
        }

        .letter-signature p {
            margin-bottom: 8px;
        }

        .letter-ps {
            margin-top: 30px;
            font-size: 10pt;
            font-style: italic;
            color: #444;
        }

        .letter-qr-section {
            margin: 20px 0 8px;
            padding: 16px;
            border: 1px solid #d9dde7;
            border-radius: 10px;
            background: #f8f9fc;
            text-align: center;
        }

        .letter-qr-label {
            font-size: 10.5pt;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .letter-qr-image {
            width: 128px;
            height: 128px;
            display: block;
            margin: 0 auto 8px;
        }

        .letter-qr-link {
            font-size: 10pt;
            color: #334155;
            text-decoration: none;
            font-weight: 600;
        }

        /* Print styles ‚Äî single letter (from modal) */
        @media print {
            body * {
                visibility: hidden;
            }

            .letter-document, .letter-document * {
                visibility: visible;
            }

            .letter-document {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: none;
                padding: 0;
                margin: 0;
            }

            .letter-qr-section {
                background: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .letter-header,
            .letter-actions,
            .letter-btn {
                display: none !important;
            }
        }

        /* Mobile adjustments for letter modal */
        @media (max-width: 768px) {
            .letter-content {
                padding: 20px;
            }

            .letter-document {
                font-size: 11pt;
            }

            .letter-qr-image {
                width: 110px;
                height: 110px;
            }

            .letter-actions {
                flex-direction: column;
            }

            .letter-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ‚îÄ‚îÄ Map area ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .map-area {
            flex: 1;
            position: relative;
            background: var(--bg);
            min-height: 400px;
        }

        .map-area iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .map-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            color: var(--text-muted);
        }

        .map-placeholder svg {
            opacity: 0.3;
        }

        .map-placeholder p {
            font-size: 14px;
        }

        /* ‚îÄ‚îÄ Loading overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .loading-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(15, 17, 23, 0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.visible {
            display: flex;
        }

        @media (max-width: 768px) {
            .loading-overlay {
                position: fixed;
                z-index: 999;
            }
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ Error toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 400px;
            z-index: 200;
            display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }

        .toast.visible { display: block; }

        /* ‚îÄ‚îÄ Bottom sheet handle (mobile only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .sheet-handle {
            display: none;
        }

        /* ‚îÄ‚îÄ Mobile floating panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 150;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 10px 12px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        .mobile-nav.visible {
            display: block;
        }

        .mobile-nav-inner {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-nav-arrow {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 18px;
            transition: background 0.15s;
        }

        .mobile-nav-arrow:active {
            background: var(--border);
        }

        .mobile-nav-arrow:disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .mobile-nav-info {
            flex: 1;
            min-width: 0;
        }

        .mobile-nav-top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 3px;
        }

        .mobile-nav-num {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .mobile-nav-num.start { background: var(--success); }
        .mobile-nav-num.end { background: var(--danger); }

        .mobile-nav-addr {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-nav-names {
            font-size: 11px;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-nav-validate {
            flex-shrink: 0;
            padding: 10px 18px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .mobile-nav-validate:active {
            background: #16a34a;
        }

        .mobile-nav-counter {
            text-align: center;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /*  RESPONSIVE MOBILE                                 */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        @media (max-width: 768px) {
            /* ‚îÄ‚îÄ Header: hidden on mobile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
            header {
                display: none;
            }

            /* ‚îÄ‚îÄ Layout: map = full screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
            .layout {
                position: relative;
                flex-direction: column;
            }

            .map-area {
                position: fixed;
                inset: 0;
                z-index: 1;
                min-height: unset;
            }

            .map-placeholder {
                align-items: center;
                justify-content: center;
            }

            /* ‚îÄ‚îÄ Sidebar ‚Üí bottom sheet overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 20;
                width: 100%;
                min-width: 100%;
                max-height: 80vh;
                max-height: 80dvh;
                border-right: none;
                border-top: none;
                border-radius: 18px 18px 0 0;
                box-shadow: 0 -6px 30px rgba(0, 0, 0, 0.5);
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                transition: transform 0.35s cubic-bezier(.4, 0, .2, 1);
                transform: translateY(0);
            }

            .sidebar-section {
                padding: 12px 16px;
            }

            .sidebar > .sidebar-section:first-of-type {
                padding-top: 4px;
            }

            /* Bottom sheet handle */
            .sheet-handle {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px 0 4px;
                cursor: grab;
                touch-action: none;
            }

            .sheet-handle-bar {
                width: 36px;
                height: 4px;
                border-radius: 2px;
                background: var(--border);
            }

            /* Collapsed state: sheet hidden, only handle peeks */
            .sidebar.sheet-collapsed {
                transform: translateY(calc(100% - 36px));
            }

            /* When sidebar has route-list visible, allow scrolling inside */
            .sidebar .route-list {
                max-height: 30vh;
                overflow-y: auto;
                flex-shrink: 0;
            }

            /* Burger menu still hidden ‚Äî we don't need it anymore */
            .menu-toggle {
                display: none !important;
            }

            /* ‚îÄ‚îÄ Form compact ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
            .stat-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .stat-card {
                padding: 8px 10px;
            }

            .stat-card .val {
                font-size: 16px;
            }

            .stat-card .lbl {
                font-size: 10px;
            }

            .route-item {
                padding: 8px 16px;
            }

            .route-num {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .route-detail .addr {
                font-size: 12px;
            }

            .route-detail .ortho-names {
                font-size: 10px;
            }

            .route-duration {
                font-size: 11px;
            }

            /* Touch-friendly buttons */
            .btn {
                padding: 12px 16px;
                font-size: 15px;
            }

            .inline-fields {
                flex-direction: column;
            }

            .inline-fields .field {
                width: 100%;
            }

            .autocomplete-dropdown {
                max-height: 180px;
            }

            select, input[type="text"], input[type="number"] {
                font-size: 16px;
                padding: 10px 12px;
            }

            .field label {
                font-size: 12px;
            }

            .field small {
                font-size: 10px !important;
            }

            #startAddress::placeholder {
                font-size: 13px;
            }

            /* Toast above mobile nav */
            .toast {
                bottom: 110px;
                right: 16px;
                left: 16px;
                max-width: none;
                font-size: 13px;
                z-index: 160;
            }

            /* Mobile nav sits above collapsed sheet */
            .mobile-nav {
                z-index: 15;
                bottom: 40px;
            }
        }

        /* Tablettes portrait */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 320px;
                min-width: 320px;
            }

            .sidebar-section {
                padding: 14px 18px;
            }

            header h1 {
                font-size: 17px;
            }

            .header-stats {
                font-size: 12px;
            }

            .map-area {
                min-height: 500px;
            }
        }

        /* Tr√®s petits √©crans (< 375px) */
        @media (max-width: 374px) {
            .sidebar-section {
                padding: 10px 12px;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                font-size: 14px;
                padding: 10px 14px;
            }

            select, input[type="text"], input[type="number"] {
                font-size: 14px;
                padding: 8px 10px;
            }

            .field label {
                font-size: 11px;
            }

            .field small {
                font-size: 9px !important;
                line-height: 1.3;
            }

            .route-item {
                padding: 6px 12px;
                gap: 8px;
            }

            .route-num {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }

            .route-detail .addr {
                font-size: 11px;
            }

            .route-detail .ortho-names {
                font-size: 9px;
            }

            .route-list {
                max-height: 20vh;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <button class="menu-toggle" id="menuToggle" aria-label="Menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
        </button>
        <h1><span>Ortho</span> Route Planner</h1>
        <div class="header-stats" id="headerStats">Chargement‚Ä¶</div>
    </header>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sheet-handle" id="sheetHandle"><div class="sheet-handle-bar"></div></div>
            <div class="sidebar-section">
                <h2>Filtre</h2>

                <div class="field">
                    <label for="cityInput">Ville</label>
                    <div class="autocomplete">
                        <input
                            type="text"
                            id="cityInput"
                            class="autocomplete-input"
                            placeholder="Rechercher une ville..."
                            autocomplete="off"
                        >
                        <div id="cityDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>

                <div class="field">
                    <label for="deptSelect">Code postal / Arrondissement</label>
                    <select id="deptSelect">
                        <option value="">Toute la ville</option>
                    </select>
                </div>

                <div class="city-info" id="cityInfo">
                    <span class="count" id="cityInfoCount">0</span> sites ‚Äî
                    <span id="cityInfoOrthos">0</span> orthophonistes
                </div>

                <!-- NOUVEAU : Point de d√©part personnalis√© -->
                <div class="field">
                    <label for="startAddress">üìç Point de d√©part (optionnel)</label>
                    <input
                        type="text"
                        id="startAddress"
                        placeholder="Ex: 15 Avenue des Champs-√âlys√©es"
                        autocomplete="off"
                    >
                    <small style="font-size:11px;color:var(--text-muted);margin-top:4px;display:block;">
                        Entrez uniquement le num√©ro et le nom de la rue (la ville est d√©j√† s√©lectionn√©e)
                    </small>
                </div>

                <!-- Rayon de recherche (visible si point de d√©part renseign√©) -->
                <div class="field" id="radiusField" style="display:none;">
                    <label for="radiusSelect">Rayon de recherche</label>
                    <select id="radiusSelect">
                        <option value="">Toute la zone</option>
                        <option value="1">1 km</option>
                        <option value="1.5">1,5 km</option>
                        <option value="2">2 km</option>
                        <option value="3" selected>3 km</option>
                        <option value="5">5 km</option>
                    </select>
                </div>

                <!-- Mode de transport -->
                <div class="field">
                    <label>Mode de transport</label>
                    <div class="transport-toggle">
                        <button type="button" class="transport-btn active" data-mode="driving" id="btnDriving">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 17h14M5 17a2 2 0 01-2-2V9a2 2 0 012-2h1l2-3h8l2 3h1a2 2 0 012 2v6a2 2 0 01-2 2M5 17a2 2 0 00-2 2v1h4v-1a2 2 0 00-2-2zm14 0a2 2 0 00-2 2v1h4v-1a2 2 0 00-2-2z"/>
                            </svg>
                            Voiture
                        </button>
                        <button type="button" class="transport-btn" data-mode="foot" id="btnFoot">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="13" cy="4" r="2"/>
                                <path d="M7 21l3-4m0 0l2-2m-2 2l-2-4 4-3 2 1 3-2m-7 4l-1 5"/>
                            </svg>
                            A pied
                        </button>
                    </div>
                </div>

                <div class="inline-fields">
                    <div class="field">
                        <label for="tspLimit">TSP (sec)</label>
                        <input type="number" id="tspLimit" value="30" min="5" max="300">
                    </div>
                    <div class="field" style="display:flex;align-items:end;">
                        <div class="checkbox-field">
                            <input type="checkbox" id="closedLoop">
                            <label for="closedLoop">Boucle ferm√©e</label>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="generateBtn" disabled>
                    G√©n√©rer l'itin√©raire
                </button>
            </div>

            <!-- Route stats -->
            <div class="route-stats" id="routeStats">
                <h2 style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:10px;">R√©sultat</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="val" id="statSites">‚Äî</div>
                        <div class="lbl">Sites visit√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="val" id="statDuration">‚Äî</div>
                        <div class="lbl">Dur√©e totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="val" id="statAvg">‚Äî</div>
                        <div class="lbl">Moy. / segment</div>
                    </div>
                    <div class="stat-card">
                        <div class="val" id="statOrthos">‚Äî</div>
                        <div class="lbl">Orthos total</div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <button class="btn btn-gmaps" style="flex:1;margin-top:0;" onclick="openGoogleMaps()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        Google Maps
                    </button>
                    <button class="btn btn-gmaps" style="flex:1;margin-top:0;" onclick="openWaze()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg>
                        Waze
                    </button>
                </div>
            </div>

            <!-- Route list with tabs -->
            <div class="route-list" id="routeList">
                <!-- Tabs -->
                <div class="route-tabs">
                    <div class="route-tab active" data-tab="tovisit">
                        √Ä visiter
                        <span class="route-tab-badge" id="tovisitCount">0</span>
                    </div>
                    <div class="route-tab" data-tab="visited">
                        Visit√©s
                        <span class="route-tab-badge" id="visitedCount">0</span>
                    </div>
                    <div class="route-tab" data-tab="printall">
                        Lettres
                        <span class="route-tab-badge" id="printallCount">0</span>
                    </div>
                </div>

                <!-- Content: √Ä visiter -->
                <div class="route-content active" id="tovisitContent">
                    <div id="routeItems"></div>
                </div>

                <!-- Content: Visit√©s -->
                <div class="route-content" id="visitedContent">
                    <div id="visitedItems">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>Aucune visite valid√©e pour le moment</p>
                        </div>
                    </div>
                </div>

                <!-- Content: Lettres (print all) -->
                <div class="route-content" id="printallContent">
                    <div class="printall-header">
                        <p class="printall-desc">Imprimer toutes les lettres personnalis√©es des praticiens √† visiter.</p>
                        <button class="printall-btn" id="printAllBtn" onclick="printAllLetters()">
                            Imprimer toutes les lettres
                        </button>
                    </div>
                    <div id="printallItems">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                            </svg>
                            <p>Aucun praticien √† visiter</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map -->
        <main class="map-area" id="mapArea">
            <div class="map-placeholder" id="mapPlaceholder">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <p>S√©lectionnez une ville et g√©n√©rez un itin√©raire</p>
            </div>

            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <p id="loadingText">Calcul de l'itin√©raire en cours‚Ä¶</p>
            </div>
        </main>
    </div>

    <!-- Mobile floating navigation panel -->
    <div class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-inner">
            <button class="mobile-nav-arrow" id="mobileNavPrev" onclick="mobileNavGo(-1)">&#8249;</button>
            <div class="mobile-nav-info">
                <div class="mobile-nav-top">
                    <div class="mobile-nav-num" id="mobileNavNum"></div>
                    <div class="mobile-nav-addr" id="mobileNavAddr"></div>
                </div>
                <div class="mobile-nav-names" id="mobileNavNames"></div>
            </div>
            <button class="mobile-nav-arrow" id="mobileNavNext" onclick="mobileNavGo(1)">&#8250;</button>
            <button class="mobile-nav-validate" id="mobileNavBtn" onclick="mobileNavValidate()">Valider &#10003;</button>
        </div>
        <div class="mobile-nav-counter" id="mobileNavCounter"></div>
    </div>

    <!-- Error toast -->
    <div class="toast" id="toast"></div>

    <!-- Letter Modal -->
    <div class="letter-modal" id="letterModal">
        <div class="letter-container">
            <div class="letter-header">
                <h3>üìÑ Lettre personnalis√©e</h3>
                <div class="letter-actions">
                    <button class="letter-btn print" onclick="printLetter()">
                        üñ®Ô∏è Imprimer
                    </button>
                    <button class="letter-btn close" onclick="closeLetter()">
                        Fermer
                    </button>
                </div>
            </div>
            <div class="letter-content">
                <div class="letter-document" id="letterDocument">
                    <!-- Letter content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const cityInput = document.getElementById('cityInput');
        const cityDropdown = document.getElementById('cityDropdown');
        const deptSelect = document.getElementById('deptSelect');
        const cityInfo = document.getElementById('cityInfo');
        const generateBtn = document.getElementById('generateBtn');
        const mapArea = document.getElementById('mapArea');
        const mapPlaceholder = document.getElementById('mapPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const routeStats = document.getElementById('routeStats');
        const routeList = document.getElementById('routeList');
        const routeItems = document.getElementById('routeItems');
        const toast = document.getElementById('toast');
        const headerStats = document.getElementById('headerStats');

        let citiesData = [];
        let selectedCity = null;
        let selectedIndex = -1;
        let startPoint = null;  // {lat, lon, address}
        let currentRoute = [];  // Current route data
        let visitedSites = [];  // Visited sites with timestamp
        let transportMode = 'driving';  // 'driving' or 'foot'

        // ‚îÄ‚îÄ Visits API management (MongoDB) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadVisitedSites() {
            try {
                const resp = await fetch('/api/visits');
                if (!resp.ok) throw new Error('Erreur chargement visites');
                const data = await resp.json();
                visitedSites = data.map(v => ({
                    site_id: v.site_id,
                    label: v.label || '',
                    lat: v.lat,
                    lon: v.lon,
                    visitedAt: v.visited_at,
                    visitedDate: v.visited_at ? new Date(v.visited_at).toLocaleDateString('fr-FR') : '',
                    visitedTime: v.visited_at ? new Date(v.visited_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '',
                }));
            } catch (e) {
                console.error('Failed to load visited sites', e);
                visitedSites = [];
            }
        }

        async function markAsVisited(siteData) {
            if (!siteData.site_id || isSiteVisited(siteData.site_id)) return false;

            try {
                const resp = await fetch('/api/visits', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        site_id: siteData.site_id,
                        label: siteData.label || '',
                        lat: siteData.lat,
                        lon: siteData.lon,
                    }),
                });
                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    throw new Error(errData.error || `Erreur serveur (${resp.status})`);
                }

                const doc = await resp.json();

                // Ajouter localement pour mise √† jour imm√©diate de l'UI
                visitedSites.unshift({
                    site_id: doc.site_id,
                    label: doc.label || siteData.label || '',
                    orthos: siteData.orthos || 0,
                    orthos_list: siteData.orthos_list || [],
                    lat: doc.lat,
                    lon: doc.lon,
                    visitedAt: doc.visited_at,
                    visitedDate: new Date(doc.visited_at).toLocaleDateString('fr-FR'),
                    visitedTime: new Date(doc.visited_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                });
            } catch (e) {
                console.error('Failed to mark visited', e);
                showToast('Erreur : ' + e.message);
                return false;
            }

            updateVisitedList();
            updateTabCounts();
            return true;
        }

        async function unmarkAsVisited(siteId) {
            try {
                const resp = await fetch(`/api/visits/${encodeURIComponent(siteId)}`, {
                    method: 'DELETE',
                });
                if (!resp.ok) throw new Error('Erreur serveur');
            } catch (e) {
                console.error('Failed to unmark visited', e);
                showToast('Erreur : impossible de supprimer la visite');
                return;
            }

            visitedSites = visitedSites.filter(v => v.site_id !== siteId);
            updateVisitedList();
            updateTabCounts();
            refreshRouteDisplay();
        }

        function isSiteVisited(siteId) {
            if (!siteId) return false;
            return visitedSites.some(v => v.site_id === siteId);
        }

        // ‚îÄ‚îÄ Tab management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initTabs() {
            document.querySelectorAll('.route-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;

                    // Update active tab
                    document.querySelectorAll('.route-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update active content
                    document.querySelectorAll('.route-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tabName}Content`).classList.add('active');
                });
            });
        }

        function updateTabCounts() {
            const toVisitCount = currentRoute.filter(r => !isSiteVisited(r.site_id)).length;
            const visitedCount = visitedSites.length;

            document.getElementById('tovisitCount').textContent = toVisitCount;
            document.getElementById('visitedCount').textContent = visitedCount;

            // Count total orthos for print tab
            const orthosCount = getAllOrthosToVisit().length;
            document.getElementById('printallCount').textContent = orthosCount;
            updatePrintallList();

            // Update mobile floating nav
            updateMobileNav();
        }

        function updateVisitedList() {
            const visitedItems = document.getElementById('visitedItems');

            if (visitedSites.length === 0) {
                visitedItems.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>Aucune visite valid√©e pour le moment</p>
                    </div>
                `;
                return;
            }

            visitedItems.innerHTML = '';
            visitedSites.forEach((site, i) => {
                const div = document.createElement('div');
                div.className = 'route-item visited';

                // Build clickable names for visited sites
                let namesHtml = '';
                if (site.orthos_list && site.orthos_list.length > 0) {
                    const clickableNames = site.orthos_list.map((o, idx) => {
                        const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                        const orthoDataJson = JSON.stringify({
                            ...o,
                            address: site.label || site.address,
                            organization_address_line: site.address || site.label,
                            organization_postal_code: site.postal_code,
                            organization_city: site.city
                        }).replace(/"/g, '&quot;');
                        return `<span class="ortho-name-link" onclick='openLetter(${orthoDataJson})' title="Cliquer pour g√©n√©rer la lettre">${name}</span>`;
                    });
                    namesHtml = clickableNames.join(', ');
                } else {
                    namesHtml = `${site.orthos} orthophoniste${site.orthos > 1 ? 's' : ''}`;
                }

                div.innerHTML = `
                    <div class="route-num visited">‚úì</div>
                    <div class="route-detail">
                        <div class="addr">${site.label || site.address || '‚Äî'}</div>
                        <div class="ortho-names" style="overflow: visible;">${namesHtml}</div>
                        <div class="visited-info">‚úì Visit√© le ${site.visitedDate} √† ${site.visitedTime}</div>
                    </div>
                    <div class="route-actions">
                        <button class="route-action-btn danger" onclick="unmarkAsVisited('${site.site_id}')" title="Annuler la visite">
                            ‚úï
                        </button>
                    </div>
                `;
                visitedItems.appendChild(div);
            });
        }

        // ‚îÄ‚îÄ Load cities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadCities() {
            try {
                const resp = await fetch('/api/cities');
                citiesData = await resp.json();

                const totalOrthos = citiesData.reduce((s, c) => s + c.orthos, 0);
                const totalSites = citiesData.reduce((s, c) => s + c.sites, 0);
                headerStats.textContent = `${citiesData.length} villes ¬∑ ${totalSites} sites ¬∑ ${totalOrthos} orthophonistes`;
            } catch (e) {
                showToast('Erreur de chargement des villes');
            }
        }

        // ‚îÄ‚îÄ Autocomplete filtering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function filterCities(query) {
            if (!query || query.length < 1) return [];

            query = query.toUpperCase();
            return citiesData.filter(c =>
                c.name.toUpperCase().includes(query)
            ).slice(0, 50); // Limit to 50 results
        }

        function renderDropdown(filtered) {
            if (filtered.length === 0) {
                cityDropdown.innerHTML = '<div class="autocomplete-empty">Aucune ville trouv√©e</div>';
                cityDropdown.classList.add('visible');
                return;
            }

            cityDropdown.innerHTML = filtered.map((c, i) => `
                <div class="autocomplete-item ${i === selectedIndex ? 'selected' : ''}" data-index="${i}">
                    <div class="city-name">${c.name}</div>
                    <div class="city-stats">${c.orthos} orthophonistes ¬∑ ${c.sites} sites</div>
                </div>
            `).join('');

            cityDropdown.classList.add('visible');

            // Add click handlers
            cityDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.index);
                    selectCity(filtered[idx]);
                });
            });
        }

        function selectCity(city) {
            selectedCity = city;
            cityInput.value = city.name;
            cityDropdown.classList.remove('visible');
            selectedIndex = -1;
            updateCityInfo(city);
        }

        function updateCityInfo(city) {
            deptSelect.innerHTML = '<option value="">Toute la ville</option>';
            generateBtn.disabled = !city;

            if (city) {
                cityInfo.classList.add('visible');
                document.getElementById('cityInfoCount').textContent = city.sites;
                document.getElementById('cityInfoOrthos').textContent = city.orthos;

                if (city.depts.length > 1) {
                    city.depts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        deptSelect.appendChild(opt);
                    });
                }
            } else {
                cityInfo.classList.remove('visible');
            }
        }

        // ‚îÄ‚îÄ Input events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        cityInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            selectedIndex = -1;

            if (!query) {
                cityDropdown.classList.remove('visible');
                selectedCity = null;
                updateCityInfo(null);
                return;
            }

            const filtered = filterCities(query);
            renderDropdown(filtered);
        });

        cityInput.addEventListener('focus', (e) => {
            // On mobile, scroll sidebar so the input + dropdown are visible
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    e.target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
            const query = e.target.value.trim();
            if (query) {
                const filtered = filterCities(query);
                renderDropdown(filtered);
            }
        });

        cityInput.addEventListener('keydown', (e) => {
            const items = cityDropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                renderDropdown(filterCities(cityInput.value.trim()));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                renderDropdown(filterCities(cityInput.value.trim()));
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    const filtered = filterCities(cityInput.value.trim());
                    selectCity(filtered[selectedIndex]);
                } else if (items.length === 1) {
                    const filtered = filterCities(cityInput.value.trim());
                    selectCity(filtered[0]);
                }
            } else if (e.key === 'Escape') {
                cityDropdown.classList.remove('visible');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete')) {
                cityDropdown.classList.remove('visible');
            }
        });

        // ‚îÄ‚îÄ Generate route ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        generateBtn.addEventListener('click', generateRoute);

        async function generateRoute() {
            if (!selectedCity) {
                showToast('Veuillez s√©lectionner une ville');
                return;
            }

            const city = selectedCity.name;
            const dept = deptSelect.value;
            const tspLimit = parseInt(document.getElementById('tspLimit').value) || 30;
            const closedLoop = document.getElementById('closedLoop').checked;

            // NOUVEAU : G√©rer le point de d√©part
            const startAddressInput = document.getElementById('startAddress').value.trim();

            if (!city) return;

            // Show loading
            generateBtn.disabled = true;
            loadingOverlay.classList.add('visible');
            collapseSheet();
            routeStats.classList.remove('visible');
            routeList.classList.remove('visible');

            try {
                // NOUVEAU : G√©ocoder le point de d√©part si fourni
                if (startAddressInput) {
                    loadingText.textContent = 'G√©ocodage du point de d√©part...';

                    // Utiliser la ville et le d√©partement s√©lectionn√©s
                    const geocodeResp = await fetch('/api/geocode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            address: startAddressInput,
                            city: city,
                            postal_code: dept
                        }),
                    });

                    const geocodeData = await geocodeResp.json();

                    if (!geocodeResp.ok) {
                        showToast(geocodeData.error || 'Impossible de g√©ocoder l\'adresse de d√©part');
                        generateBtn.disabled = false;
                        loadingOverlay.classList.remove('visible');
                        return;
                    }

                    startPoint = {
                        lat: geocodeData.latitude,
                        lon: geocodeData.longitude,
                        address: geocodeData.geocoded_label
                    };

                    loadingText.textContent = `D√©part: ${startPoint.address}`;
                } else {
                    startPoint = null;
                }

                const modeLabel = transportMode === 'foot' ? 'a pied' : 'en voiture';
                loadingText.textContent = `Calcul de l'itin√©raire ${modeLabel}‚Ä¶`;

                const body = {
                    city: city,
                    dept: dept,
                    closed_loop: closedLoop,
                    tsp_limit: tspLimit,
                    transport_mode: transportMode,
                };

                // Ajouter point de d√©part et rayon si d√©finis
                if (startPoint) {
                    body.start_lat = startPoint.lat;
                    body.start_lon = startPoint.lon;
                    body.start_address = startPoint.address;

                    const radiusVal = document.getElementById('radiusSelect').value;
                    if (radiusVal) {
                        body.radius_km = parseFloat(radiusVal);
                    }
                }

                const resp = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body),
                });

                const data = await resp.json();

                if (!resp.ok) {
                    showToast(data.error || 'Erreur serveur');
                    return;
                }

                // Show map
                mapPlaceholder.style.display = 'none';
                const existingIframe = mapArea.querySelector('iframe');
                if (existingIframe) existingIframe.remove();

                const iframe = document.createElement('iframe');
                iframe.srcdoc = data.map_html;
                mapArea.appendChild(iframe);

                // Show stats
                if (data.stats) {
                    const s = data.stats;
                    if (s.visited_sites) {
                        document.getElementById('statSites').textContent = s.visited_sites;
                        document.getElementById('statDuration').textContent =
                            s.total_duration_h >= 1
                                ? `${s.total_duration_h}h`
                                : `${s.total_duration_min} min`;
                        document.getElementById('statAvg').textContent = `${s.avg_segment_min} min`;

                        const totalOrthos = data.route.reduce((sum, r) => sum + r.orthos, 0);
                        document.getElementById('statOrthos').textContent = totalOrthos;

                        routeStats.classList.add('visible');
                    }

                    if (s.message) {
                        showToast(s.message);
                    }
                }

                // Show route list
                if (data.route && data.route.length > 0) {
                    currentRoute = data.route;
                    routeItems.innerHTML = '';
                    const n = data.route.length;

                    data.route.forEach((r, i) => {
                        const div = document.createElement('div');
                        const isVisited = isSiteVisited(r.site_id);
                        div.className = 'route-item' + (isVisited ? ' visited' : '');

                        let numClass = 'route-num';
                        if (isVisited) {
                            numClass += ' visited';
                        } else {
                            if (i === 0) numClass += ' start';
                            else if (i === n - 1) numClass += ' end';
                        }

                        // Build orthos names list with clickable names
                        let namesHtml = '';
                        let fullNames = '';
                        if (r.orthos_list && r.orthos_list.length > 0) {
                            // Create clickable name elements
                            const clickableNames = r.orthos_list.map((o, idx) => {
                                const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                                const orthoDataJson = JSON.stringify({
                                    ...o,
                                    address: r.label,
                                    organization_address_line: r.address || r.label,
                                    organization_postal_code: r.postal_code,
                                    organization_city: r.city
                                }).replace(/"/g, '&quot;');
                                return `<span class="ortho-name-link" onclick='openLetter(${orthoDataJson})' title="Cliquer pour g√©n√©rer la lettre">${name}</span>`;
                            });

                            fullNames = r.orthos_list.map(o => `${o.given_names || ''} ${o.family_name || ''}`.trim()).join(', ');

                            // Display first 2 names, then count
                            if (clickableNames.length === 1) {
                                namesHtml = `üë§ ${clickableNames[0]}`;
                            } else if (clickableNames.length === 2) {
                                namesHtml = `üë• ${clickableNames[0]}, ${clickableNames[1]}`;
                            } else {
                                namesHtml = `üë• ${clickableNames[0]}, ${clickableNames[1]} <span title="${fullNames}">(+${clickableNames.length - 2})</span>`;
                            }
                        } else {
                            namesHtml = `${r.orthos} orthophoniste${r.orthos > 1 ? 's' : ''}`;
                        }

                        const visitedBadge = isVisited ? '<div class="visited-info">‚úì D√©j√† visit√©</div>' : '';

                        div.innerHTML = `
                            <div class="${numClass}">${isVisited ? '‚úì' : r.order}</div>
                            <div class="route-detail">
                                <div class="addr" title="${r.label}">${r.label || '‚Äî'}</div>
                                <div class="ortho-names" style="overflow: visible;">${namesHtml}</div>
                                ${visitedBadge}
                            </div>
                            <div class="route-duration">
                                ${r.segment_min > 0 ? `+<strong>${r.segment_min}</strong> min` : '<strong>D√©part</strong>'}
                            </div>
                            <div class="route-actions">
                                ${!isVisited ? `<button class="route-action-btn success" onclick="validateVisit(${i})" title="Marquer comme visit√©">‚úì</button>` : ''}
                            </div>
                        `;
                        routeItems.appendChild(div);
                    });

                    routeList.classList.add('visible');
                    updateTabCounts();
                }

            } catch (e) {
                showToast('Erreur r√©seau : ' + e.message);
            } finally {
                loadingOverlay.classList.remove('visible');
                generateBtn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Validate visit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function validateVisit(routeIndex) {
            if (routeIndex >= 0 && routeIndex < currentRoute.length) {
                const site = currentRoute[routeIndex];
                const ok = await markAsVisited(site);
                if (!ok) return;
                showToast(`‚úì Visite valid√©e : ${site.label || site.address}`);

                // Refresh the route display to update the UI
                refreshRouteDisplay();
            }
        }

        function refreshRouteDisplay() {
            const routeItems = document.getElementById('routeItems');
            if (currentRoute.length === 0) return;

            routeItems.innerHTML = '';
            const n = currentRoute.length;

            currentRoute.forEach((r, i) => {
                const div = document.createElement('div');
                const isVisited = isSiteVisited(r.site_id);
                div.className = 'route-item' + (isVisited ? ' visited' : '');

                let numClass = 'route-num';
                if (isVisited) {
                    numClass += ' visited';
                } else {
                    if (i === 0) numClass += ' start';
                    else if (i === n - 1) numClass += ' end';
                }

                // Build orthos names list with clickable names
                let namesHtml = '';
                let fullNames = '';
                if (r.orthos_list && r.orthos_list.length > 0) {
                    // Create clickable name elements
                    const clickableNames = r.orthos_list.map((o, idx) => {
                        const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                        const orthoDataJson = JSON.stringify({
                            ...o,
                            address: r.label,
                            organization_address_line: r.address || r.label,
                            organization_postal_code: r.postal_code,
                            organization_city: r.city
                        }).replace(/"/g, '&quot;');
                        return `<span class="ortho-name-link" onclick='openLetter(${orthoDataJson})' title="Cliquer pour g√©n√©rer la lettre">${name}</span>`;
                    });

                    fullNames = r.orthos_list.map(o => `${o.given_names || ''} ${o.family_name || ''}`.trim()).join(', ');

                    // Display first 2 names, then count
                    if (clickableNames.length === 1) {
                        namesHtml = `üë§ ${clickableNames[0]}`;
                    } else if (clickableNames.length === 2) {
                        namesHtml = `üë• ${clickableNames[0]}, ${clickableNames[1]}`;
                    } else {
                        namesHtml = `üë• ${clickableNames[0]}, ${clickableNames[1]} <span title="${fullNames}">(+${clickableNames.length - 2})</span>`;
                    }
                } else {
                    namesHtml = `${r.orthos} orthophoniste${r.orthos > 1 ? 's' : ''}`;
                }

                const visitedBadge = isVisited ? '<div class="visited-info">‚úì D√©j√† visit√©</div>' : '';

                div.innerHTML = `
                    <div class="${numClass}">${isVisited ? '‚úì' : r.order}</div>
                    <div class="route-detail">
                        <div class="addr" title="${r.label}">${r.label || '‚Äî'}</div>
                        <div class="ortho-names" style="overflow: visible;">${namesHtml}</div>
                        ${visitedBadge}
                    </div>
                    <div class="route-duration">
                        ${r.segment_min > 0 ? `+<strong>${r.segment_min}</strong> min` : '<strong>D√©part</strong>'}
                    </div>
                    <div class="route-actions">
                        ${!isVisited ? `<button class="route-action-btn success" onclick="validateVisit(${i})" title="Marquer comme visit√©">‚úì</button>` : ''}
                    </div>
                `;
                routeItems.appendChild(div);
            });

            updateTabCounts();
        }

        // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 5000);
        }

        // ‚îÄ‚îÄ Transport mode toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.querySelectorAll('.transport-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                transportMode = btn.dataset.mode;
            });
        });

        // ‚îÄ‚îÄ Mobile bottom sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const sidebar = document.getElementById('sidebar');
        const sheetHandle = document.getElementById('sheetHandle');

        function collapseSheet() {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('sheet-collapsed');
            }
        }

        function expandSheet() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('sheet-collapsed');
            }
        }

        function toggleSheet() {
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('sheet-collapsed');
            }
        }

        // Tap handle to toggle
        if (sheetHandle) {
            sheetHandle.addEventListener('click', toggleSheet);
        }

        // Tap on map (outside sidebar) to collapse the sheet
        document.getElementById('mapArea').addEventListener('click', () => {
            if (window.innerWidth <= 768 && !sidebar.classList.contains('sheet-collapsed')) {
                collapseSheet();
            }
        });

        // Collapse sheet when route is generated on mobile
        generateBtn.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                // Delay collapse until after route loads
                const observer = new MutationObserver(() => {
                    if (document.querySelector('.map-area iframe')) {
                        collapseSheet();
                        observer.disconnect();
                    }
                });
                observer.observe(document.querySelector('.map-area'), { childList: true });
            }
        });

        // ‚îÄ‚îÄ Responsive placeholders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updatePlaceholders() {
            const startAddressInput = document.getElementById('startAddress');
            const width = window.innerWidth;

            if (width <= 374) {
                // Tr√®s petit mobile
                startAddressInput.placeholder = "Ex: 15 Ave Champs-√âlys√©es";
                cityInput.placeholder = "Ville...";
            } else if (width <= 768) {
                // Mobile
                startAddressInput.placeholder = "Ex: 15 Avenue des Champs-√âlys√©es";
                cityInput.placeholder = "Rechercher une ville...";
            } else {
                // Desktop
                startAddressInput.placeholder = "Ex: 15 Avenue des Champs-√âlys√©es";
                cityInput.placeholder = "Rechercher une ville...";
            }
        }

        // Update on load and resize
        updatePlaceholders();
        window.addEventListener('resize', updatePlaceholders);

        // ‚îÄ‚îÄ Show/hide radius field based on start address ‚îÄ‚îÄ‚îÄ
        const startAddressField = document.getElementById('startAddress');
        const radiusField = document.getElementById('radiusField');

        startAddressField.addEventListener('input', () => {
            radiusField.style.display = startAddressField.value.trim() ? 'block' : 'none';
        });

        // ‚îÄ‚îÄ Google Maps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openGoogleMaps() {
            const stops = currentRoute.filter(r => !isSiteVisited(r.site_id));
            if (stops.length === 0) return;

            // Google Maps URL: /dir/lat,lng/lat,lng/...
            // Limit to ~25 waypoints (Google Maps URL limit)
            const points = stops.slice(0, 25);
            const path = points.map(s => `${s.lat},${s.lon}`).join('/');
            const mode = transportMode === 'foot' ? 'walking' : 'driving';

            const url = `https://www.google.com/maps/dir/${path}/?travelmode=${mode}`;
            window.open(url, '_blank');
        }

        function openWaze() {
            const stops = currentRoute.filter(r => !isSiteVisited(r.site_id));
            if (stops.length === 0) return;

            // Waze ne supporte qu'une seule destination √† la fois
            // On ouvre le premier stop non visit√©
            const next = stops[0];
            const url = `https://waze.com/ul?ll=${next.lat},${next.lon}&navigate=yes`;
            window.open(url, '_blank');
        }

        // ‚îÄ‚îÄ Print all letters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getAllOrthosToVisit() {
            const orthos = [];
            currentRoute.forEach(r => {
                if (isSiteVisited(r.site_id)) return;
                if (r.orthos_list && r.orthos_list.length > 0) {
                    r.orthos_list.forEach(o => {
                        orthos.push({
                            ...o,
                            address: r.label,
                            organization_address_line: r.address || r.label,
                            organization_postal_code: r.postal_code,
                            organization_city: r.city,
                            _order: r.order
                        });
                    });
                }
            });
            return orthos;
        }

        function updatePrintallList() {
            const container = document.getElementById('printallItems');
            const orthos = getAllOrthosToVisit();

            if (orthos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                        </svg>
                        <p>Aucun praticien √† visiter</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            orthos.forEach((o, i) => {
                const name = `${o.given_names || ''} ${o.family_name || ''}`.trim();
                const addr = `${o.organization_postal_code || ''} ${o.organization_city || ''}`.trim();
                const div = document.createElement('div');
                div.className = 'printall-item';
                div.innerHTML = `
                    <div class="printall-order">${i + 1}</div>
                    <div class="printall-info">
                        <div class="printall-name">${name || 'Orthophoniste'}</div>
                        <div class="printall-addr">${addr || '‚Äî'}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openLetterPrintWindow(pagesHtml) {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) return;

            printWindow.document.write(`<!DOCTYPE html>
<html><head>
<title> </title>
<style>
    @page { margin: 10mm 15mm; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        background: white;
        color: #000;
        font-family: 'Georgia', 'Times New Roman', serif;
        font-size: 10.5pt;
        line-height: 1.45;
    }
    .letter-page {
        max-width: 595px;
        margin: 0 auto;
        padding: 0;
        page-break-after: always;
    }
    .letter-page:last-child {
        page-break-after: auto;
    }
    .letter-to { text-align: left; margin-bottom: 16px; }
    .letter-to-name { font-weight: bold; font-size: 10.5pt; }
    .letter-to-address { font-size: 9.5pt; color: #374151; margin-top: 2px; }
    .letter-date { text-align: right; margin-bottom: 12px; font-size: 9.5pt; color: #6b7280; }
    .letter-subject { font-weight: bold; margin-bottom: 12px; font-size: 10.5pt; }
    .letter-body p { margin-bottom: 6px; }
    .letter-body ul { margin-left: 20px; margin-bottom: 6px; }
    .letter-qr-section {
        margin: 10px 0 4px;
        padding: 10px;
        border: 1px solid #d9dde7;
        border-radius: 10px;
        background: #f8f9fc;
        text-align: center;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    .letter-qr-label { font-size: 9.5pt; margin-bottom: 6px; color: #1f2937; }
    .letter-qr-image { width: 100px; height: 100px; display: block; margin: 0 auto 4px; }
    .letter-qr-link { font-size: 9.5pt; color: #334155; text-decoration: none; font-weight: 600; }
    .letter-signature { margin-top: 14px; }
    .letter-signature p { margin-bottom: 1px; font-size: 9.5pt; }
    .letter-ps { margin-top: 10px; font-size: 9.5pt; font-style: italic; color: #374151; }
</style>
</head><body>${pagesHtml}</body></html>`);
            printWindow.document.close();

            // Wait for images (QR code) to load, then print
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        }

        function printAllLetters() {
            const orthos = getAllOrthosToVisit();
            if (orthos.length === 0) return;

            // Build all letters HTML
            let pagesHtml = '';
            orthos.forEach(o => {
                pagesHtml += `<div class="letter-page">${generateLetterContent(o)}</div>`;
            });

            openLetterPrintWindow(pagesHtml);
        }

        // ‚îÄ‚îÄ Letter Modal Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generateLetterContent(orthoData) {
            const today = new Date().toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Format the recipient name
            const recipientName = orthoData.given_names && orthoData.family_name
                ? `${orthoData.given_names} ${orthoData.family_name}`
                : orthoData.organization_name || '';

            // Civilit√© : utiliser celle du backend (gender-guesser), sinon fallback
            const civility = orthoData.civility || 'Madame, Monsieur';

            // Salutation avec nom : "Madame Dupont" ou "Monsieur Martin" ou "Madame, Monsieur"
            const salutation = orthoData.family_name && civility !== 'Madame, Monsieur'
                ? `${civility} ${orthoData.family_name}`
                : `${civility}`;

            // "curieux" ou "curieuse" selon la civilit√©
            const curieux = civility === 'Madame' ? 'curieuse' : civility === 'Monsieur' ? 'curieux' : 'curieux(se)';

            // Format the address
            const addressLine = orthoData.organization_address_line || orthoData.address || '';
            const postalCode = orthoData.organization_postal_code || orthoData.postal_code || '';
            const city = orthoData.organization_city || orthoData.city || '';

            return `
                <div class="letter-to">
                    <div class="letter-to-name">${recipientName}</div>
                    <div class="letter-to-address">
                        ${addressLine}<br>
                        ${postalCode} ${city}
                    </div>
                </div>

                <div class="letter-date">
                    Paris, le ${today}
                </div>
                <div class="letter-subject">
                    Objet : Recherche de collaboration ‚Äî plateforme pour orthophonistes
                </div>

                <div class="letter-body">
                    <p>${salutation},</p>

                    <p>
                        Je m'appelle Nathan Krief, j'ai 22 ans et je suis √©tudiant-entrepreneur.
                        Je d√©veloppe <strong>Logesia</strong>, une plateforme num√©rique con√ßue pour
                        lib√©rer du temps clinique aux orthophonistes en r√©duisant la charge administrative.
                    </p>

                    <p><strong>Pourquoi je vous √©cris personnellement ?</strong></p>

                    <p>
                        En √©changeant avec plusieurs orthophonistes, j'ai r√©alis√© √† quel point
                        le m√©tier consacre un temps consid√©rable √† l'administratif ‚Äî au d√©triment du
                        temps pass√© avec les patients. C'est ce constat qui m'a donn√© envie de cr√©er
                        un outil pour r√©√©quilibrer cela.
                    </p>

                    <p><strong>Concr√®tement, Logesia vous permet de :</strong></p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li>r√©duire le temps pass√© sur les comptes rendus et la documentation clinique ;</li>
                        <li>g√©n√©rer des exercices personnalis√©s, adapt√©s √† chaque patient et √† ses progr√®s ;</li>
                        <li>structurer le suivi th√©rapeutique avec une trame adaptative, s√©ance apr√®s s√©ance.</li>
                    </ul>
                    <p>
                        L'ensemble est assist√© par intelligence artificielle, mais vous gardez le
                        contr√¥le √† chaque √©tape : c'est vous qui d√©cidez, l'outil s'adapte √† votre
                        pratique. Et ce n'est qu'un d√©but ‚Äî de nombreuses fonctionnalit√©s sont en
                        cours de d√©veloppement.
                    </p>
                    <p><strong>Ce que je recherche, ce n'est pas un client, mais un regard d'expert.</strong></p>
                    <p>
                        La plateforme existe et fonctionne. Mais pour qu'elle soit vraiment utile au
                        quotidien, j'ai besoin de professionnels de terrain : vos retours et vos
                        suggestions sont essentiels pour que l'outil colle vraiment √† la r√©alit√© du terrain.
                        Concr√®tement, je cherche des orthophonistes pr√™ts √† tester Logesia et √† me
                        faire part de leurs observations, m√™me les plus critiques.
                        Bien entendu, l'acc√®s √† la plateforme sera enti√®rement gratuit pour vous.
                    </p>
                    <p>
                        Si vous √™tes ${curieux}, scannez le QR code ci-dessous pour d√©couvrir Logesia,
                        ou contactez-moi directement :
                    </p>
                    <div class="letter-qr-section">
                        <div class="letter-qr-label">Scannez ce QR code pour d√©couvrir Logesia :</div>
                        <img class="letter-qr-image" src="/qr-code.svg" alt="QR code vers Logesia">
                        <a class="letter-qr-link" href="https://logesia.com" target="_blank" rel="noopener noreferrer">logesia.com</a>
                    </div>
                </div>
                <div class="letter-signature">
                    <p><strong>Nathan Krief</strong></p>
                    <p>06 29 40 04 23</p>
                    <p>nathan@logesia.com</p>
                </div>
                <div class="letter-ps">
                    <p>
                        <strong>P.S. :</strong> Je serais √©galement ravi de vous rencontrer autour
                        d'un caf√© pour vous pr√©senter la plateforme en personne : 30 minutes suffisent.
                    </p>
                </div>
            `;
        }

        function openLetter(orthoData) {
            const letterDocument = document.getElementById('letterDocument');
            const letterModal = document.getElementById('letterModal');

            letterDocument.innerHTML = generateLetterContent(orthoData);
            letterModal.classList.add('visible');

            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeLetter() {
            const letterModal = document.getElementById('letterModal');
            letterModal.classList.remove('visible');
            document.body.style.overflow = '';
        }

        function printLetter() {
            const letterDocument = document.getElementById('letterDocument');
            if (!letterDocument || !letterDocument.innerHTML.trim()) return;

            const pagesHtml = `<div class="letter-page">${letterDocument.innerHTML}</div>`;
            openLetterPrintWindow(pagesHtml);
        }

        // Close modal when clicking outside
        document.getElementById('letterModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'letterModal') {
                closeLetter();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLetter();
            }
        });

        // ‚îÄ‚îÄ Mobile floating nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let mobileNavIndex = 0;

        function isMobile() {
            return window.innerWidth <= 768;
        }

        function getUnvisitedStops() {
            return currentRoute
                .map((r, i) => ({ ...r, _routeIndex: i }))
                .filter(r => !isSiteVisited(r.site_id));
        }

        function updateMobileNav() {
            const nav = document.getElementById('mobileNav');
            if (!isMobile() || currentRoute.length === 0) {
                nav.classList.remove('visible');
                return;
            }

            const stops = getUnvisitedStops();
            if (stops.length === 0) {
                nav.classList.remove('visible');
                return;
            }

            if (mobileNavIndex >= stops.length) mobileNavIndex = stops.length - 1;
            if (mobileNavIndex < 0) mobileNavIndex = 0;

            const stop = stops[mobileNavIndex];
            const n = currentRoute.length;

            // Num badge
            const numEl = document.getElementById('mobileNavNum');
            numEl.textContent = stop.order;
            numEl.className = 'mobile-nav-num';
            if (stop._routeIndex === 0) numEl.classList.add('start');
            else if (stop._routeIndex === n - 1) numEl.classList.add('end');

            // Address
            document.getElementById('mobileNavAddr').textContent = stop.label || '‚Äî';

            // Names
            let names = '';
            if (stop.orthos_list && stop.orthos_list.length > 0) {
                names = stop.orthos_list.map(o =>
                    `${o.given_names || ''} ${o.family_name || ''}`.trim()
                ).join(', ');
            }
            document.getElementById('mobileNavNames').textContent = names;

            // Counter
            document.getElementById('mobileNavCounter').textContent =
                `${mobileNavIndex + 1} / ${stops.length} restant${stops.length > 1 ? 's' : ''}`;

            // Arrows
            document.getElementById('mobileNavPrev').disabled = mobileNavIndex === 0;
            document.getElementById('mobileNavNext').disabled = mobileNavIndex >= stops.length - 1;

            // Show
            nav.classList.add('visible');
        }

        function mobileNavGo(delta) {
            const stops = getUnvisitedStops();
            mobileNavIndex += delta;
            if (mobileNavIndex < 0) mobileNavIndex = 0;
            if (mobileNavIndex >= stops.length) mobileNavIndex = stops.length - 1;
            updateMobileNav();
        }

        async function mobileNavValidate() {
            const stops = getUnvisitedStops();
            if (stops.length === 0) return;

            const stop = stops[mobileNavIndex];
            const ok = await markAsVisited(stop);
            if (!ok) return;
            showToast(`Visite validee : ${stop.label || ''}`);
            refreshRouteDisplay();
            updateMobileNav();
        }

        // Update on resize
        window.addEventListener('resize', updateMobileNav);

        // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function init() {
            await loadVisitedSites();
            initTabs();
            updateVisitedList();
            loadCities();
        }
        init();
    </script>
</body>
</html>
